// Generated by Pdef Objective-C generator.

#import "{{ module|objc_filename }}.h"
{% for imported_module in module.imported_modules %}
#import "{{ imported_module|objc_filename }}Descriptors.h"
{% endfor %}


{% for definition in module.definitions %}
{% if definition.is_message %}
@implementation {{ definition.name }}
- (PDMessageDescriptor *)descriptor {
    return {{ definition.name }}Descriptor();
}
@end


{% endif %}
{% endfor -%}



// Descriptors
{% for definition in module.definitions %}
    {% if definition.is_enum %}
static dispatch_once_t _{{ definition.name }}Once;
static PDEnumDescriptor *_{{ definition.name }}Descriptor;
PDEnumDescriptor *{{ definition.name }}Descriptor() {
    dispatch_once(&_{{ definition.name }}Once, ^() {
        _{{ definition.name }}Descriptor = [[PDEnumDescriptor alloc] initWithNumbersToNames:@{
            {% for value in definition.values %}
                @({{ loop.index }}): @"{{ value.name }}",
            {% endfor %}
        }];
    });
    return _{{ definition.name }}Descriptor;
}


    {% elif definition.is_message %}
static dispatch_once_t _{{ definition.name }}Once;
static PDMessageDescriptor *_{{ definition.name }}Descriptor;
PDMessageDescriptor *{{ definition.name }}Descriptor() {
    dispatch_once(&_{{ definition.name }}Once, ^() {
        _{{ definition.name }}Descriptor = [[PDMessageDescriptor alloc]
                initWithClass:[{{ definition.name }} class]
                         base:{% if definition.base -%}
                                  {{ definition.base }}Descriptor()
                              {% else -%}
                                  nil
                              {% endif %}
           discriminatorValue:{% if definition.discriminator_value -%}
                                  {{ definition.discriminator_value|objc_type }}
                              {% else -%}
                                  0
                              {% endif %}
        {% if definition.subtypes %}
             subtypeSuppliers:@[
                    {% for subtype in definition.subtypes %}
                               ^PDMessageDescriptor *() { return {{ subtype.name }}Descriptor(); },
                    {% endfor %}
                              ]
        {% else %}
             subtypeSuppliers:@[]
        {% endif %}
                       fields:@[
                    {% for field in definition.declared_fields %}
                               [[PDFieldDescriptor alloc] initWithName:@"{{ field.name }}"
                                       typeSupplier:^PDDataTypeDescriptor *() { return {{ field.type|objc_descriptor }}; }
                                    isDiscriminator:{{ field.is_discriminator|objc_bool }}],
                    {% endfor %}
                               ]];
    });
    return _{{ definition.name }}Descriptor;
}


    {% else %}
    {% endif %}
{% endfor %}
